# Rhetoric Lens 安装与使用指南

## 📋 前置要求

### 1. Ollama 配置

确保 Ollama 已启动并加载了模型：

```bash
# 检查 Ollama 是否运行
curl http://localhost:11434/api/tags

# 确认模型已加载（应该能看到 xiuci-win-pro:latest）
```

### 2. CORS 配置（重要！）

浏览器扩展调用本地 Ollama 需要配置 CORS：

**Windows:**
```powershell
# 设置环境变量
setx OLLAMA_ORIGINS "*"

# 重启 Ollama 服务
# 方法1: 在任务管理器中结束 ollama.exe，然后重新启动
# 方法2: 如果是服务，重启服务
```

**Mac/Linux:**
```bash
# 设置环境变量
launchctl setenv OLLAMA_ORIGINS "*"

# 重启 Ollama
pkill ollama
ollama serve
```

**验证 CORS 是否生效:**
```bash
# 打开浏览器控制台，运行以下代码测试
fetch('http://localhost:11434/api/tags')
  .then(r => r.json())
  .then(console.log)
  .catch(console.error)
```

如果返回模型列表则配置成功，如果提示 CORS 错误则需要重新配置。

---

## 🚀 安装步骤

### 1. 加载扩展到 Chrome

1. 打开 Chrome 浏览器
2. 地址栏输入: `chrome://extensions/`
3. 打开右上角的 **"开发者模式"** (Developer mode)
4. 点击左上角的 **"加载已解压的扩展程序"** (Load unpacked)
5. 选择 `rhetoric-detector-extension` 文件夹
6. 确认扩展已加载（应该能看到 "Rhetoric Lens - 舆论透镜"）

### 2. 验证安装

1. 点击扩展图标（或在扩展列表中找到 Rhetoric Lens）
2. 打开配置页面（popup）
3. 检查连接状态：
   - ✅ 已连接到Ollama - 表示配置正确
   - ❌ 无法连接 - 检查 Ollama 是否运行和 CORS 配置

---

## 🎯 使用方法

### 基本使用

1. 打开 [Twitter/X](https://x.com) 或 [twitter.com](https://twitter.com)
2. 扩展会自动开始分析推文
3. 等待几秒，推文下方会出现彩色标签：
   - 🟢 **绿色** (0-4分): 低风险，修辞使用正常
   - 🟡 **黄色** (5-7分): 中风险，存在一定修辞操纵
   - 🔴 **红色** (8-10分): 高风险，强烈修辞/情绪操纵
4. **鼠标悬停**在标签上查看详细分析

### 配置选项

点击扩展图标打开配置页面：

#### API 配置
- **API 地址**: Ollama API 端点（默认: `http://localhost:11434/api/chat`）
- **模型名称**: 使用的模型（默认: `xiuci-win-pro:latest`）

#### 分析设置
- **自动分析推文**:
  - ✅ 开启: 滚动时自动分析所有推文
  - ❌ 关闭: 需要点击 "🔍 分析修辞" 按钮才分析（适合降低 API 调用频率）

#### 统计信息
- **已分析**: 当前会话已分析的推文数量
- **缓存数**: 本地缓存的分析结果数量

#### 操作按钮
- **保存设置**: 保存配置并重新测试连接
- **清除缓存**: 删除所有缓存的分析结果

---

## 🔍 测试验证

### 1. 打开浏览器控制台

在 Twitter 页面按 `F12` 打开开发者工具，切换到 Console 标签页。

### 2. 查看日志

应该能看到以下日志：
```
[Rhetoric Lens] 🚀 启动中...
[Rhetoric Lens] 配置已加载: {API_ENDPOINT: "...", MODEL_NAME: "..."}
[Rhetoric Lens] 从缓存加载了 X 条记录
[Rhetoric Lens] ✅ 已启动 | 模型: xiuci-win-pro:latest | 并发数: 3
```

### 3. 测试分析

1. 滚动 Twitter 页面查看新推文
2. 观察推文下方是否出现：
   - 蓝色 "分析中..." 标签（短暂出现）
   - 彩色分析结果标签（绿/黄/红）
3. 悬停查看详细分析信息

### 4. 检查缓存

```javascript
// 在控制台运行，查看缓存内容
chrome.storage.local.get(['rhetoricCache'], (result) => {
  console.log('缓存数据:', JSON.parse(result.rhetoricCache || '{}'));
});
```

---

## ⚙️ 性能优化

### 当前优化策略

1. **请求队列**: 最多同时 3 个并发请求，避免压垮本地服务器
2. **滚动防抖**: 停止滚动 500ms 后才处理新推文
3. **双重缓存**:
   - 内存缓存（会话级别）
   - localStorage 缓存（持久化，24小时过期）
4. **智能去重**:
   - 文本级别去重（避免重复调用 API）
   - DOM 级别去重（避免重复处理同一元素）

### 如果遇到性能问题

1. **降低并发数**: 编辑 `content.js` 中的 `MAX_CONCURRENT` (默认 3)
2. **增加防抖延迟**: 编辑 `DEBOUNCE_DELAY` (默认 500ms)
3. **关闭自动分析**: 在配置页面关闭自动分析，改为手动点击模式

---

## 🐛 常见问题

### Q1: 扩展加载了但不工作

**检查清单:**
- [ ] Ollama 是否正在运行？(`http://localhost:11434/api/tags`)
- [ ] CORS 是否已配置？（环境变量 `OLLAMA_ORIGINS=*`）
- [ ] 模型名称是否正确？（`xiuci-win-pro:latest`）
- [ ] 是否在 x.com 或 twitter.com 域名？
- [ ] 浏览器控制台是否有错误？

### Q2: 显示 "分析失败" 或 "无法连接"

**解决方法:**
1. 确认 Ollama 正在运行
2. 测试 API: `curl http://localhost:11434/api/tags`
3. 检查 CORS 配置（最常见问题）
4. 重启 Ollama 服务
5. 在扩展配置页面点击 "保存设置" 重新测试连接

### Q3: 分析速度很慢

**可能原因:**
- 模型推理速度慢（Mac Mini M4 应该较快）
- 同时分析太多推文
- 网络延迟（虽然是本地调用）

**优化建议:**
- 关闭自动分析，改为手动点击模式
- 检查系统资源使用情况
- 确认 Ollama 日志中没有警告

### Q4: 缓存占用太多空间

```javascript
// 在控制台查看缓存大小
chrome.storage.local.getBytesInUse('rhetoricCache', (bytes) => {
  console.log('缓存占用:', (bytes / 1024).toFixed(2), 'KB');
});
```

**清理方法:**
- 在扩展配置页面点击 "清除缓存"
- 或手动执行: `chrome.storage.local.remove('rhetoricCache')`

### Q5: 某些推文没有被分析

**可能原因:**
- 推文文本太短（< 10 字符自动跳过）
- 推文已在缓存中（刷新页面后会重新显示）
- Twitter DOM 结构变化（X/Twitter 经常更新页面结构）

---

## 📊 技术细节

### Badge 颜色逻辑

```javascript
maxScore = max(rhetoric_score, manipulation_score)

if maxScore >= 8: 红色 (高风险)
if maxScore >= 5: 黄色 (中风险)
if maxScore <  5: 绿色 (低风险)
```

### 数据流

```
Twitter 页面加载/滚动
  ↓
MutationObserver 检测新推文
  ↓
提取推文文本 (data-testid="tweetText")
  ↓
检查缓存 (simpleHash)
  ↓
POST 到 Ollama API (JSON 模式)
  ↓
解析响应: {label, rhetoric_score, manipulation_score, reason}
  ↓
创建彩色 Badge + Tooltip
  ↓
插入到推文下方
```

### 缓存结构

```json
{
  "<textHash>": {
    "data": {
      "label": "政治宣传",
      "rhetoric_score": 8,
      "manipulation_score": 9,
      "reason": "..."
    },
    "timestamp": 1736668800000
  }
}
```

---

## 🔧 开发调试

### 修改代码后重新加载

1. 在 `chrome://extensions/` 页面
2. 找到 Rhetoric Lens
3. 点击刷新图标 ⟳
4. 刷新 Twitter 页面

### 查看详细日志

所有日志都带 `[Rhetoric Lens]` 前缀，在控制台筛选：
```
[Rhetoric Lens]
```

### 手动触发分析

```javascript
// 在控制台执行，手动扫描当前页面
scanCurrentPage();
```

---

## 📦 数据收集与模型训练（可选）

如果你想收集数据用于训练自己的模型，请查看：
- **[数据收集完整指南](./README_数据收集.md)**

**快速开始：**

1. 安装 Python 依赖：
```bash
pip install -r requirements.txt
```

2. 启动数据收集服务器：
```bash
python save_server.py
```

3. 插件会自动将分析结果保存为 JSONL 格式，适合模型训练

**数据清洗：**
```bash
python preprocess_data.py
```

---

## 📝 后续优化建议

- [ ] 添加黑/白名单功能（只分析特定账号）
- [ ] 添加快捷键支持
- [ ] 支持更多社交媒体平台
- [ ] 添加数据可视化（统计图表）
- [ ] 云端 API 支持（不依赖本地 Ollama）
- [ ] 多语言支持

---

## 🆘 获取帮助

如遇问题：
1. 检查浏览器控制台的错误信息
2. 检查 Ollama 服务日志
3. 确认所有配置步骤都已正确完成

**日志位置:**
- 扩展日志: 浏览器开发者工具 Console
- Ollama 日志: 根据操作系统不同，通常在系统日志中

---

祝使用愉快！🎉
