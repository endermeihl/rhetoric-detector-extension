# Rhetoric Lens (èˆ†è®ºé€é•œ) - å®Œæ•´å®ç°æ–¹æ¡ˆ

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

**Rhetoric Lens** æ˜¯ä¸€ä¸ª Chrome æµè§ˆå™¨æ‰©å±•ï¼Œé€šè¿‡ AI å®æ—¶åˆ†æ Twitter/X å¹³å°ä¸Šçš„æ¨æ–‡ï¼Œè¯†åˆ«ä¿®è¾æ‰‹æ³•å’Œæ“çºµç­–ç•¥ï¼Œå¹¶ä»¥å¯è§†åŒ–æ–¹å¼å±•ç¤ºåˆ†æç»“æœã€‚ç”¨æˆ·åœ¨æµè§ˆæ¨æ–‡æ—¶ï¼Œæ‰©å±•ä¼šè‡ªåŠ¨åœ¨æ¨æ–‡ä¸‹æ–¹æ˜¾ç¤ºå½©è‰²å¾½ç« ï¼Œæ˜¾ç¤º**ä¿®è¾å¯†åº¦**å’Œ**æ“çºµæŒ‡æ•°**è¯„åˆ†ï¼Œé¼ æ ‡æ‚¬åœå¯æŸ¥çœ‹è¯¦ç»†åˆ†æã€‚

### æ ¸å¿ƒä»·å€¼
- **éšæ€§åˆ°æ˜¾æ€§**: å°† AI æ¨ç†èƒ½åŠ›è½¬åŒ–ä¸ºç›´è§‚çš„è§†è§‰è¾…åŠ©
- **å®æ—¶åˆ†æ**: æ— ç¼é›†æˆåˆ°ç”¨æˆ·æµè§ˆæµç¨‹ä¸­
- **æ•°æ®æ”¶é›†**: è‡ªåŠ¨æ„å»ºè®­ç»ƒæ•°æ®é›†ï¼Œæ”¯æŒæ¨¡å‹è¿­ä»£ä¼˜åŒ–

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### ç³»ç»Ÿç»„æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Twitter/X ç½‘é¡µ                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Content Script (content.js)                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ ç›‘å¬å™¨      â”‚â†’ â”‚ æå–å™¨      â”‚â†’ â”‚ åˆ†æå™¨      â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ Observer   â”‚  â”‚ Extractor  â”‚  â”‚ Analyzer   â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚                                         â”‚           â”‚   â”‚
â”‚  â”‚                                         â†“           â”‚   â”‚
â”‚  â”‚                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚                               â”‚ æ¸²æŸ“å™¨          â”‚   â”‚   â”‚
â”‚  â”‚                               â”‚ Renderer       â”‚   â”‚   â”‚
â”‚  â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                     â”‚
                â†“                     â†“
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Ollama API   â”‚      â”‚ æ•°æ®æ”¶é›†æœåŠ¡  â”‚
      â”‚ (AIæ¨ç†)     â”‚      â”‚ (Python)     â”‚
      â”‚ Port: 11434  â”‚      â”‚ Port: 8881   â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯ | è¯´æ˜ |
|------|------|------|
| å‰ç«¯ | Chrome Extension API (Manifest V3) | æ‰©å±•æ¡†æ¶ |
| è„šæœ¬ | Vanilla JavaScript (ES6+) | æ ¸å¿ƒé€»è¾‘ |
| æ ·å¼ | CSS3 | å¾½ç« å’ŒTooltipæ ·å¼ |
| AIæ¨ç† | Ollama (xiuci-pro æ¨¡å‹) | æœ¬åœ°LLMæ¨ç† |
| æ•°æ®æ”¶é›† | FastAPI + Python | è®­ç»ƒæ•°æ®å­˜å‚¨ |
| å­˜å‚¨ | Chrome Storage API + JSONL | ç¼“å­˜å’Œæ•°æ®æŒä¹…åŒ– |

---

## ğŸ”‘ æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. æ¨æ–‡ç›‘å¬ (MutationObserver)

**æŒ‘æˆ˜**: Twitter/X ä½¿ç”¨æ— é™æ»šåŠ¨åŠ è½½ï¼ŒDOM èŠ‚ç‚¹åŠ¨æ€ç”Ÿæˆã€‚

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨ `MutationObserver` ç›‘å¬æ•´ä¸ª `document.body` çš„å˜åŒ–ã€‚

```javascript
const observer = new MutationObserver((mutations) => {
  // 200ms é˜²æŠ–ï¼Œé¿å…é¢‘ç¹è§¦å‘
  clearTimeout(mutationDebounceTimeout);
  mutationDebounceTimeout = setTimeout(() => {
    for (const mutation of mutations) {
      for (const node of mutation.addedNodes) {
        // æ£€æµ‹æ–°å¢çš„æ¨æ–‡å®¹å™¨
        if (node.matches && node.matches('article[data-testid="tweet"]')) {
          processTweet(node);
        }
      }
    }
  }, 200);
});

observer.observe(document.body, {
  childList: true,  // ç›‘å¬å­èŠ‚ç‚¹å˜åŒ–
  subtree: true     // é€’å½’ç›‘å¬æ‰€æœ‰åä»£èŠ‚ç‚¹
});
```

**å…³é”®ç‚¹**:
- Twitter ä½¿ç”¨æ··æ·†çš„ class åç§°ï¼Œå¿…é¡»ä¾èµ– `data-testid` å±æ€§
- ä½¿ç”¨ 200ms é˜²æŠ–é¿å…è¿‡äºé¢‘ç¹çš„å¤„ç†
- åŒæ—¶ç›‘å¬æ»šåŠ¨äº‹ä»¶ï¼Œåœ¨æ»šåŠ¨åœæ­¢åæ‰«æå½“å‰è§†å£

---

### 2. æ–‡æœ¬æå– (DOM Selector)

**é€‰æ‹©å™¨ç­–ç•¥**:
```javascript
// âœ… æ¨èï¼šä½¿ç”¨ç¨³å®šçš„ data-testid
const textNode = tweetElement.querySelector('[data-testid="tweetText"]');

// âŒ ä¸æ¨èï¼šä¾èµ– classï¼ˆä¼šå˜åŒ–ï¼‰
// const textNode = tweetElement.querySelector('.css-1jxf684');
```

**å»é‡æœºåˆ¶**:
- **DOM çº§åˆ«**: `tweetElement.dataset.aiProcessed = "true"`
- **æ–‡æœ¬çº§åˆ«**: `state.processedTweets.add(text)`ï¼ˆä¼šè¯çº§ Setï¼‰
- **ç¼“å­˜çº§åˆ«**: `simpleHash(text)` ä½œä¸º key å­˜å‚¨åœ¨ Chrome Storage

---

### 3. AI åˆ†æ (Ollama API è°ƒç”¨)

**è¯·æ±‚æ ¼å¼**:
```javascript
const response = await fetch("http://localhost:11434/api/chat", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    model: "xiuci-win-pro:latest",
    messages: [{ role: "user", content: text }],
    format: "json",        // ğŸ”´ å¼ºåˆ¶ JSON è¾“å‡º
    stream: false          // ğŸ”´ ç¦ç”¨æµå¼å“åº”
  })
});

const data = await response.json();
const result = JSON.parse(data.message.content);
```

**å“åº”æ ¼å¼**:
```json
{
  "label": "æƒ…ç»ªç…½åŠ¨",
  "rhetoric_score": 8,
  "manipulation_score": 9,
  "reason": "é€šè¿‡å¤¸å¤§å¯¹æ¯”å’Œç»å¯¹åŒ–è¡¨è¿°åˆ¶é€ ææ…Œæƒ…ç»ª..."
}
```

**å¹¶å‘æ§åˆ¶**:
```javascript
const CONFIG = {
  MAX_CONCURRENT: 3,  // æœ€å¤š 3 ä¸ªå¹¶å‘è¯·æ±‚
  DEBOUNCE_DELAY: 500 // æ»šåŠ¨åœæ­¢å 500ms æ‰åˆ†æ
};

// ä»»åŠ¡é˜Ÿåˆ—å¤„ç†
function processQueue() {
  while (state.activeRequests < CONFIG.MAX_CONCURRENT
         && state.pendingQueue.length > 0) {
    const task = state.pendingQueue.shift();
    performAnalysis(task.text, task.insertPoint);
  }
}
```

**CORS è§£å†³æ–¹æ¡ˆ**:
- **Mac/Linux**: `launchctl setenv OLLAMA_ORIGINS "*"` (é‡å¯ Ollama)
- **Windows**: è®¾ç½®ç¯å¢ƒå˜é‡ `OLLAMA_ORIGINS=*`
- æˆ–è€…åœ¨ `manifest.json` ä¸­æ·»åŠ  `host_permissions`

---

### 4. ç»“æœæ¸²æŸ“ (Badge + Tooltip)

**å¾½ç« æ’å…¥ä½ç½®**:
```javascript
function findBadgeInsertPoint(tweetElement) {
  // æ–¹æ¡ˆ1: action bar (ç‚¹èµ/è½¬å‘æŒ‰é’®) ä¸Šæ–¹
  const actionBar = tweetElement.querySelector('[role="group"]');
  if (actionBar && actionBar.parentElement) {
    const container = document.createElement("div");
    container.className = "ai-badge-container";
    actionBar.parentElement.insertBefore(container, actionBar);
    return container;
  }

  // æ–¹æ¡ˆ2: æ¨æ–‡æ–‡æœ¬ä¸‹æ–¹ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
  const textNode = tweetElement.querySelector('[data-testid="tweetText"]');
  // ...
}
```

**é¢œè‰²åˆ†çº§è§„åˆ™**:
```javascript
function getColorClass(rhetoric, manipulation) {
  const maxScore = Math.max(rhetoric, manipulation);
  if (maxScore >= 8) return "score-danger";   // çº¢è‰² (é«˜é£é™©)
  if (maxScore >= 5) return "score-warning";  // æ©™è‰² (ä¸­é£é™©)
  return "score-safe";                        // ç»¿è‰² (ä½é£é™©)
}
```

**Tooltip å®ç°ç»†èŠ‚**:
- ä½¿ç”¨ `position: fixed` å®šä½åˆ° bodyï¼Œé¿å…è¢« Twitter æ ·å¼è¦†ç›–
- åŠ¨æ€è®¡ç®—ä½ç½®ï¼Œç¡®ä¿ä¸è¶…å‡ºå±å¹•è¾¹ç•Œ
- æ”¯æŒé¼ æ ‡ç§»åŠ¨åˆ° tooltip ä¸Šæ—¶ä¿æŒæ˜¾ç¤º
- ä½¿ç”¨ `z-index: 2147483647` ç¡®ä¿æœ€é«˜å±‚çº§

---

### 5. ç¼“å­˜æœºåˆ¶

**ä¸‰çº§ç¼“å­˜ç­–ç•¥**:

```javascript
// 1ï¸âƒ£ å†…å­˜ç¼“å­˜ (Map)
const state = {
  cache: new Map(),  // å¿«é€Ÿè®¿é—®
  processedTweets: new Set()  // ä¼šè¯å»é‡
};

// 2ï¸âƒ£ Chrome Storage (æŒä¹…åŒ–)
async function saveCache(key, data) {
  state.cache.set(key, data);  // å†…å­˜

  const cached = await chrome.storage.local.get(['rhetoricCache']);
  cached[key] = {
    data: data,
    timestamp: Date.now()
  };
  await chrome.storage.local.set({ rhetoricCache: JSON.stringify(cached) });
}

// 3ï¸âƒ£ æ•°æ®åº“ (è®­ç»ƒé›†)
async function saveAnalysisRecord(text, result) {
  await fetch('http://127.0.0.1:8881/save', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      tweet_content: text,
      analysis_result: result,
      tweet_url: window.location.href
    })
  });
}
```

**ç¼“å­˜è¿‡æœŸ**: 24 å°æ—¶åè‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®ã€‚

---

### 6. æ•°æ®æ”¶é›†æœåŠ¡ (FastAPI)

**æœåŠ¡ç«¯å®ç°** (`save_server.py`):

```python
@app.post("/save")
async def save_data(request: Request):
    data = await request.json()
    analysis_result = data.get("analysis_result")

    # è·³è¿‡é”™è¯¯åˆ†æ
    if analysis_result.get("error"):
        return {"status": "skipped", "reason": "analysis contains error"}

    # æ„å»º JSONL æ ¼å¼è®­ç»ƒæ•°æ®
    record = {
        "text": data.get("tweet_content"),
        "analysis": json.dumps({
            "rhetoric_score": analysis_result.get("rhetoric_score"),
            "manipulation_score": analysis_result.get("manipulation_score"),
            "label": analysis_result.get("label"),
            "reason": analysis_result.get("reason")
        }, ensure_ascii=False)
    }

    # è¿½åŠ å†™å…¥ JSONL æ–‡ä»¶
    with open("twitter_training_data.jsonl", "a", encoding="utf-8") as f:
        f.write(json.dumps(record, ensure_ascii=False) + "\n")
```

**å¯åŠ¨æ–¹å¼**:
```bash
pip install fastapi uvicorn
python save_server.py
# æœåŠ¡è¿è¡Œåœ¨ http://127.0.0.1:8881
```

**æ•°æ®æ ¼å¼** (JSONL):
```jsonl
{"text": "æ¨æ–‡å†…å®¹...", "analysis": "{\"rhetoric_score\":8,\"manipulation_score\":9,...}"}
{"text": "æ¨æ–‡å†…å®¹...", "analysis": "{\"rhetoric_score\":5,\"manipulation_score\":6,...}"}
```

---

## âš ï¸ å…³é”®æŠ€æœ¯éš¾ç‚¹ä¸è§£å†³æ–¹æ¡ˆ

### éš¾ç‚¹ 1: Twitter DOM ç»“æ„å¤æ‚ä¸”åŠ¨æ€å˜åŒ–

**é—®é¢˜**:
- class åç§°æ··æ·† (å¦‚ `css-1jxf684`)
- æ— é™æ»šåŠ¨åŠ¨æ€åŠ è½½
- SPA æ¶æ„ï¼Œé¡µé¢ä¸åˆ·æ–°

**è§£å†³æ–¹æ¡ˆ**:
- âœ… ä½¿ç”¨ `data-testid` è€Œé class é€‰æ‹©å™¨
- âœ… MutationObserver ç›‘å¬ DOM å˜åŒ–
- âœ… é˜²æŠ–æœºåˆ¶é¿å…è¿‡åº¦è§¦å‘
- âœ… å¤šå±‚å»é‡ (DOM æ ‡è®° + æ–‡æœ¬ Set + ç¼“å­˜ hash)

---

### éš¾ç‚¹ 2: CORS è·¨åŸŸé™åˆ¶

**é—®é¢˜**: Chrome æ‰©å±•è°ƒç”¨æœ¬åœ° Ollama API è¢«æµè§ˆå™¨æ‹¦æˆªã€‚

**è§£å†³æ–¹æ¡ˆ**:
1. **Ollama ç«¯**: è®¾ç½®ç¯å¢ƒå˜é‡ `OLLAMA_ORIGINS=*`
2. **æ‰©å±•ç«¯**: åœ¨ `manifest.json` æ·»åŠ  `host_permissions`
   ```json
   "host_permissions": [
     "http://localhost:11434/*"
   ]
   ```
3. **CSP**: é…ç½® `content_security_policy` å…è®¸è¿æ¥
   ```json
   "content_security_policy": {
     "extension_pages": "... connect-src 'self' http://localhost:11434"
   }
   ```

---

### éš¾ç‚¹ 3: å¹¶å‘æ€§èƒ½é—®é¢˜

**é—®é¢˜**: æ»šåŠ¨åŠ è½½ 20 æ¡æ¨æ–‡ä¼šç¬é—´å‘èµ· 20 ä¸ª API è¯·æ±‚ï¼Œå¯¼è‡´ï¼š
- Mac Mini èµ„æºå æ»¡
- æµè§ˆå™¨å¡é¡¿
- ç½‘ç»œæ‹¥å µ

**è§£å†³æ–¹æ¡ˆ**:
1. **ä»»åŠ¡é˜Ÿåˆ—**: åªæœ‰ `activeRequests < MAX_CONCURRENT` æ‰å¤„ç†æ–°ä»»åŠ¡
2. **æ»šåŠ¨é˜²æŠ–**: åœæ­¢æ»šåŠ¨ 500ms åæ‰åˆ†æ
3. **æ™ºèƒ½ç¼“å­˜**: å‘½ä¸­ç¼“å­˜ç›´æ¥è¿”å›ï¼Œæ— éœ€è¯·æ±‚
4. **å¯é€‰æ‰‹åŠ¨æ¨¡å¼**: ç‚¹å‡» "ğŸ” åˆ†æä¿®è¾" æŒ‰é’®æ‰è§¦å‘

---

### éš¾ç‚¹ 4: Tooltip æ˜¾ç¤ºé—®é¢˜

**é—®é¢˜**: Tooltip å®¹æ˜“è¢« Twitter æ ·å¼è¦†ç›–æˆ–å®šä½é”™è¯¯ã€‚

**è§£å†³æ–¹æ¡ˆ**:
- âœ… å°† tooltip é™„åŠ åˆ° `document.body` è€Œé badge å†…éƒ¨
- âœ… ä½¿ç”¨ `position: fixed` + åŠ¨æ€è®¡ç®—åæ ‡
- âœ… `z-index: 2147483647` ç¡®ä¿æœ€é¡¶å±‚
- âœ… è¾¹ç•Œæ£€æµ‹ï¼Œé˜²æ­¢è¶…å‡ºå±å¹•

```javascript
function positionTooltip(badge, tooltip) {
  const rect = badge.getBoundingClientRect();
  let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
  let top = rect.top - tooltipRect.height - 10;

  // è¾¹ç•Œä¿®æ­£
  if (left < 10) left = 10;
  if (left + tooltipRect.width > window.innerWidth - 10) {
    left = window.innerWidth - tooltipRect.width - 10;
  }
  if (top < 10) top = rect.bottom + 10; // æ˜¾ç¤ºåœ¨ä¸‹æ–¹

  tooltip.style.left = `${left}px`;
  tooltip.style.top = `${top}px`;
}
```

---

### éš¾ç‚¹ 5: æ‰©å±•ä¸Šä¸‹æ–‡å¤±æ•ˆ

**é—®é¢˜**: æ‰©å±•é‡æ–°åŠ è½½åï¼Œ`chrome.runtime.id` å¤±æ•ˆï¼Œå¯¼è‡´ `chrome.storage` è°ƒç”¨æŠ¥é”™ã€‚

**è§£å†³æ–¹æ¡ˆ**:
```javascript
function isExtensionContextValid() {
  try {
    return chrome.runtime?.id !== undefined;
  } catch (error) {
    return false;
  }
}

// åœ¨æ‰€æœ‰ Chrome API è°ƒç”¨å‰æ£€æŸ¥
if (!isExtensionContextValid()) {
  console.warn("æ‰©å±•ä¸Šä¸‹æ–‡å¤±æ•ˆï¼Œè·³è¿‡æ“ä½œ");
  return;
}
```

---

## ğŸ“¦ éƒ¨ç½²æµç¨‹

### ç¯å¢ƒå‡†å¤‡

1. **å®‰è£… Ollama** (æœ¬åœ° AI æ¨ç†):
   ```bash
   # Mac
   brew install ollama

   # Windows/Linux
   https://ollama.ai/download
   ```

2. **åŠ è½½æ¨¡å‹**:
   ```bash
   ollama pull xiuci-win-pro:latest
   # æˆ–ä½¿ç”¨è‡ªå®šä¹‰æ¨¡å‹: ollama create xiuci-pro -f Modelfile
   ```

3. **é…ç½® CORS**:
   ```bash
   # Mac/Linux
   launchctl setenv OLLAMA_ORIGINS "*"

   # Windows (PowerShell ç®¡ç†å‘˜)
   [System.Environment]::SetEnvironmentVariable("OLLAMA_ORIGINS", "*", "Machine")

   # é‡å¯ Ollama
   ollama serve
   ```

4. **å¯åŠ¨æ•°æ®æ”¶é›†æœåŠ¡**:
   ```bash
   pip install fastapi uvicorn
   python save_server.py
   ```

---

### å®‰è£…æ‰©å±•

1. æ‰“å¼€ Chrome æµè§ˆå™¨ï¼Œè®¿é—® `chrome://extensions/`
2. å¼€å¯å³ä¸Šè§’çš„ **"å¼€å‘è€…æ¨¡å¼"**
3. ç‚¹å‡» **"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"**
4. é€‰æ‹©é¡¹ç›®æ–‡ä»¶å¤¹ `rhetoric-detector-extension`
5. ç¡®è®¤æ‰©å±•å›¾æ ‡å‡ºç°åœ¨å·¥å…·æ 

---

### æµ‹è¯•éªŒè¯

#### 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
```bash
# Ollama API
curl http://localhost:11434/api/tags

# æ•°æ®æ”¶é›†æœåŠ¡
curl http://127.0.0.1:8881/health
```

#### 2. æ‰“å¼€ Twitter/X
- è®¿é—® https://x.com
- æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)
- æŸ¥çœ‹ Console æ˜¯å¦è¾“å‡º: `[Rhetoric Lens] ğŸš€ å¯åŠ¨ä¸­...`

#### 3. æ»šåŠ¨é¡µé¢
- è§‚å¯Ÿæ¨æ–‡ä¸‹æ–¹æ˜¯å¦å‡ºç°å¾½ç« 
- é¼ æ ‡æ‚¬åœæŸ¥çœ‹ tooltip
- æ£€æŸ¥ Console ä¸­çš„æ—¥å¿—

---

## ğŸš€ ä¼˜åŒ–å»ºè®®

### æ€§èƒ½ä¼˜åŒ–

1. **è§†å£æ£€æµ‹**: åªåˆ†æå½“å‰å¯è§åŒºåŸŸçš„æ¨æ–‡
   ```javascript
   function isInViewport(element) {
     const rect = element.getBoundingClientRect();
     return rect.top < window.innerHeight && rect.bottom > 0;
   }
   ```

2. **è¯·æ±‚æ‰¹å¤„ç†**: å°†å¤šä¸ªæ¨æ–‡åˆå¹¶ä¸ºä¸€ä¸ªè¯·æ±‚
   ```javascript
   // æ”¶é›† 5 æ¡æ¨æ–‡åæ‰¹é‡åˆ†æ
   const batch = [];
   if (batch.length >= 5) {
     await analyzeBatch(batch);
   }
   ```

3. **æ‡’åŠ è½½ç­–ç•¥**: é»˜è®¤ä¸åˆ†æï¼Œæ·»åŠ  "ğŸ”" å›¾æ ‡è®©ç”¨æˆ·æ‰‹åŠ¨è§¦å‘

---

### ç”¨æˆ·ä½“éªŒä¼˜åŒ–

1. **åŠ è½½åŠ¨ç”»**: åˆ†ææ—¶æ˜¾ç¤ºæ—‹è½¬çš„åŠ è½½å›¾æ ‡
   ```css
   .loading-spinner {
     animation: spin 0.8s linear infinite;
   }
   ```

2. **é”™è¯¯æç¤º**: API å¤±è´¥æ—¶æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯
   ```javascript
   if (error.message.includes("Failed to fetch")) {
     reason = "æ— æ³•è¿æ¥åˆ° AI æœåŠ¡ï¼Œè¯·ç¡®ä¿ Ollama æ­£åœ¨è¿è¡Œ";
   }
   ```

3. **é”®ç›˜å¿«æ·é”®**: æŒ‰ `Alt + R` åˆ†æå½“å‰æ¨æ–‡

---

### å®‰å…¨ä¼˜åŒ–

1. **å†…å®¹è½¬ä¹‰**: é˜²æ­¢ XSS æ”»å‡»
   ```javascript
   function escapeHtml(text) {
     const div = document.createElement('div');
     div.textContent = text;
     return div.innerHTML;
   }
   ```

2. **API å¯†é’¥ç®¡ç†**: å¦‚æœä½¿ç”¨äº‘ç«¯ APIï¼Œä½¿ç”¨ `chrome.storage.sync` åŠ å¯†å­˜å‚¨

3. **é€Ÿç‡é™åˆ¶**: å•ä½æ—¶é—´å†…é™åˆ¶è¯·æ±‚æ¬¡æ•°

---

### åŠŸèƒ½æ‰©å±•

1. **å¤šå¹³å°æ”¯æŒ**: æ‰©å±•åˆ° Redditã€å¾®åšã€çŸ¥ä¹
   ```json
   "matches": [
     "https://x.com/*",
     "https://www.reddit.com/*",
     "https://weibo.com/*"
   ]
   ```

2. **å¯¼å‡ºæŠ¥å‘Š**: ç”Ÿæˆå½“å‰é¡µé¢çš„ä¿®è¾åˆ†ææŠ¥å‘Š (PDF/Markdown)

3. **ç”¨æˆ·åé¦ˆ**: æ·»åŠ  "ğŸ‘ å‡†ç¡® / ğŸ‘ ä¸å‡†" æŒ‰é’®ï¼Œæ”¶é›†æ ‡æ³¨æ•°æ®

4. **æ·±è‰²æ¨¡å¼**: é€‚é… Twitter çš„æ·±è‰²ä¸»é¢˜

5. **å¤šè¯­è¨€æ”¯æŒ**: æ”¯æŒè‹±æ–‡ã€ä¸­æ–‡ã€æ—¥æ–‡ç­‰

---

## ğŸ“Š ç›‘æ§ä¸ç»´æŠ¤

### æ—¥å¿—ç³»ç»Ÿ

```javascript
// ç»Ÿä¸€æ—¥å¿—æ ¼å¼
console.log(`[Rhetoric Lens] ${emoji} ${message}`, data);

// æ—¥å¿—ç­‰çº§
// ğŸš€ å¯åŠ¨ | ğŸ¯ å¤„ç† | âœ… æˆåŠŸ | âŒ é”™è¯¯ | âš ï¸ è­¦å‘Š | ğŸ“Š ç»Ÿè®¡
```

### æ€§èƒ½æŒ‡æ ‡

ç›‘æ§å…³é”®æŒ‡æ ‡ï¼š
- API å“åº”æ—¶é—´ (å¹³å‡ < 2s)
- ç¼“å­˜å‘½ä¸­ç‡ (ç›®æ ‡ > 60%)
- è®­ç»ƒæ•°æ®å¢é•¿é€Ÿåº¦ (æ¡/å¤©)
- å†…å­˜å ç”¨ (< 100MB)

### é”™è¯¯å¤„ç†

```javascript
try {
  await performAnalysis(text, insertPoint);
} catch (error) {
  // 1. è®°å½•é”™è¯¯åˆ°æœ¬åœ°
  console.error("[Rhetoric Lens] âŒ", error);

  // 2. æ˜¾ç¤ºé™çº§ UI
  showErrorBadge(insertPoint);

  // 3. ä¸ä¸­æ–­å…¶ä»–æ¨æ–‡çš„å¤„ç†
  processQueue();
}
```

---

## ğŸ” å®‰å…¨ä¸éšç§

### æ•°æ®éšç§

- âœ… æ‰€æœ‰åˆ†ææ•°æ®æœ¬åœ°å¤„ç†ï¼ˆOllama æœ¬åœ°è¿è¡Œï¼‰
- âœ… ä»…åœ¨ç”¨æˆ·åŒæ„æ—¶æ”¶é›†è®­ç»ƒæ•°æ®
- âœ… ä¸ä¸Šä¼ ä»»ä½•ä¸ªäººèº«ä»½ä¿¡æ¯
- âœ… æ•°æ®å­˜å‚¨åœ¨æœ¬åœ° (JSONL æ–‡ä»¶)

### æƒé™è¯´æ˜

```json
"permissions": [
  "storage",     // ç¼“å­˜åˆ†æç»“æœ
  "activeTab"    // ä»…åœ¨å½“å‰æ ‡ç­¾é¡µå·¥ä½œ
]
```

**ä¸éœ€è¦**:
- âŒ `webRequest` (ä¸æ‹¦æˆªç½‘ç»œè¯·æ±‚)
- âŒ `cookies` (ä¸è¯»å–ç”¨æˆ·èº«ä»½)
- âŒ `tabs` (ä¸è®¿é—®æ‰€æœ‰æ ‡ç­¾é¡µ)

---

## ğŸ“ é¡¹ç›®ç»“æ„æ€»è§ˆ

```
rhetoric-detector-extension/
â”œâ”€â”€ manifest.json           # æ‰©å±•é…ç½®æ–‡ä»¶ (å…³é”®!)
â”œâ”€â”€ content.js              # æ ¸å¿ƒé€»è¾‘è„šæœ¬ (700+ è¡Œ)
â”œâ”€â”€ styles.css              # å¾½ç« æ ·å¼
â”œâ”€â”€ save_server.py          # æ•°æ®æ”¶é›†æœåŠ¡
â”œâ”€â”€ preprocess_data.py      # æ•°æ®é¢„å¤„ç†è„šæœ¬
â”œâ”€â”€ requirements.txt        # Python ä¾èµ–
â”œâ”€â”€ twitter_training_data.jsonl  # è®­ç»ƒæ•°æ® (è‡ªåŠ¨ç”Ÿæˆ)
â”œâ”€â”€ icon16.svg              # æ‰©å±•å›¾æ ‡ 16x16
â”œâ”€â”€ icon48.svg              # æ‰©å±•å›¾æ ‡ 48x48
â”œâ”€â”€ icon128.svg             # æ‰©å±•å›¾æ ‡ 128x128
â”œâ”€â”€ README.md               # ç”¨æˆ·æ–‡æ¡£
â”œâ”€â”€ å®ç°æ–¹æ¡ˆ.md             # æœ¬æ–‡æ¡£
â”œâ”€â”€ éœ€æ±‚å’Œè®¾è®¡.md           # éœ€æ±‚åˆ†æ
â””â”€â”€ å®‰è£…æŒ‡å—.md             # å®‰è£…æ­¥éª¤

ä»£ç ç»Ÿè®¡:
- JavaScript: ~700 è¡Œ
- CSS: ~300 è¡Œ
- Python: ~120 è¡Œ
```

---

## ğŸ¯ æ ¸å¿ƒä»·å€¼æ€»ç»“

### æŠ€æœ¯äº®ç‚¹

1. âœ… **Chrome Extension Manifest V3**: ä½¿ç”¨æœ€æ–°è§„èŒƒ
2. âœ… **MutationObserver**: ç›‘å¬ SPA åŠ¨æ€ DOM å˜åŒ–
3. âœ… **å¹¶å‘æ§åˆ¶**: ä»»åŠ¡é˜Ÿåˆ— + é˜²æŠ– + é™æµ
4. âœ… **ä¸‰çº§ç¼“å­˜**: å†…å­˜ + Chrome Storage + æ•°æ®åº“
5. âœ… **æœ¬åœ° LLM é›†æˆ**: Ollama API è°ƒç”¨
6. âœ… **æ•°æ®é—­ç¯**: è‡ªåŠ¨æ”¶é›†è®­ç»ƒæ•°æ®ï¼Œæ”¯æŒæ¨¡å‹è¿­ä»£

### äº§å“äº®ç‚¹

1. âœ… **æ— ç¼é›†æˆ**: ä¸å¹²æ‰°åŸæœ‰æµè§ˆä½“éªŒ
2. âœ… **å®æ—¶åé¦ˆ**: åˆ†æç»“æœå³æ—¶å¯è§
3. âœ… **çµæ´»é…ç½®**: å¯åœ¨ä»£ç ä¸­è‡ªå®šä¹‰ API åœ°å€ã€æ¨¡å‹åç§°ã€å¹¶å‘æ•°ç­‰å‚æ•°
4. âœ… **éšç§å®‰å…¨**: æœ¬åœ°å¤„ç†ï¼Œæ— æ•°æ®ä¸Šä¼ 

### å•†ä¸šä»·å€¼

1. **æŠ€èƒ½å±•ç¤º**: å…¨æ ˆ AI å·¥ç¨‹å¸ˆèƒ½åŠ›è¯æ˜
2. **å¼€æºæ½œåŠ›**: å¯å‘å¸ƒåˆ° Chrome Web Store
3. **æ•°æ®èµ„äº§**: æŒç»­ç§¯ç´¯é«˜è´¨é‡è®­ç»ƒæ•°æ®
4. **æ¨¡å‹è¿­ä»£**: æ”¯æŒ RLHF (äººç±»åé¦ˆå¼ºåŒ–å­¦ä¹ )

---

## ğŸ› å·²çŸ¥é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜ 1: Twitter å¸ƒå±€æ›´æ–°å¯¼è‡´æ’å…¥ç‚¹å¤±æ•ˆ

**ä¸´æ—¶è§£å†³**: å¤šç§æ’å…¥ç‚¹å¤‡é€‰æ–¹æ¡ˆ (è§ `findBadgeInsertPoint` å‡½æ•°)

**é•¿æœŸè§£å†³**: å®šæœŸæ£€æŸ¥ Twitter DOM ç»“æ„å˜åŒ–ï¼Œæ›´æ–°é€‰æ‹©å™¨

---

### é—®é¢˜ 2: Ollama å“åº”é€Ÿåº¦æ…¢ (2-5s)

**è§£å†³æ–¹æ¡ˆ**:
- ä½¿ç”¨æ›´å°çš„æ¨¡å‹ (å¦‚ `llama3.2:3b`)
- å¯ç”¨ GPU åŠ é€Ÿ
- å¢åŠ ç¼“å­˜å‘½ä¸­ç‡

---

### é—®é¢˜ 3: è®­ç»ƒæ•°æ®è´¨é‡ä¸å‡

**è§£å†³æ–¹æ¡ˆ**:
- æ·»åŠ ç”¨æˆ·åé¦ˆæœºåˆ¶ (ğŸ‘/ğŸ‘)
- å®šæœŸäººå·¥å®¡æ ¸æ•°æ®
- ä½¿ç”¨ä¸»åŠ¨å­¦ä¹ ç­–ç•¥

---

## ğŸ“ è”ç³»ä¸æ”¯æŒ

- **é—®é¢˜åé¦ˆ**: é€šè¿‡ GitHub Issues
- **åŠŸèƒ½å»ºè®®**: é€šè¿‡ Discussions
- **ä»£ç è´¡çŒ®**: æ¬¢è¿æäº¤ Pull Request

---

## ğŸ“„ è®¸å¯è¯

MIT License - å¼€æºå…è´¹ä½¿ç”¨

---

**æœ€åæ›´æ–°**: 2025-01-12
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0
**ä½œè€…**: Rhetoric Lens Team
