# 🚨 数据保存问题解决方案

## 问题原因
**找到了！manifest.json 中的端口配置错误：**
- ❌ 错误配置：`http://127.0.0.1:8888/*` 
- ✅ 正确配置：`http://127.0.0.1:8881/*`

## ✅ 已修复的问题

1. **manifest.json** - 更新了 `host_permissions` 和 CSP 策略为正确的8881端口
2. **save_server.py** - 修正了打印信息中的端口号
3. **content.js** - 增强了日志输出，便于调试

## 📝 立即操作步骤

### 第1步：重新加载扩展 ⭐️ **必须执行**

1. 打开 Chrome 浏览器
2. 访问 `chrome://extensions/`
3. 找到 **Rhetoric Lens** 扩展
4. 点击右下角的 🔄 **重新加载** 按钮

### 第2步：清除缓存

由于之前的分析结果被缓存了，需要清除缓存：

**方法1：使用开发者工具**
1. 打开任意页面，按 F12
2. Application 标签 → Storage → Chrome Extension Storage
3. 找到并删除 `rhetoricCache`

**方法2：使用清除工具**
1. 到扩展目录
2. 在浏览器打开 `clear-cache.html`
3. 点击"清除所有缓存"按钮

### 第3步：访问 Twitter 测试

1. 访问 https://x.com 或 https://twitter.com
2. 按 F12 打开开发者工具，切换到 Console 标签
3. 滚动页面，让扩展开始分析推文
4. 观察控制台日志

## 🔍 预期看到的日志

成功保存时的完整日志流程：
```
[Rhetoric Lens] 配置已加载: {API_ENDPOINT: "...", ...}
[Rhetoric Lens] 💾 准备保存新分析结果
[Rhetoric Lens] 🔄 正在保存数据到服务器... {url: "http://127.0.0.1:8881/save", ...}
[Rhetoric Lens] ✅ 已保存至数据集 (总计: 1 条)
```

缓存命中时：
```
[Rhetoric Lens] 命中缓存: ...
[Rhetoric Lens] ⏭️ 跳过保存：命中缓存
```

连接失败时：
```
[Rhetoric Lens] ❌ 保存数据失败: TypeError: Failed to fetch
[Rhetoric Lens] ⚠️ 无法连接到数据收集服务 (端口 8881)
```

## 🧪 验证数据保存

在PowerShell中运行：
```powershell
# 查看保存的记录数
Get-Content twitter_training_data.jsonl | Measure-Object -Line

# 查看最新一条记录
Get-Content twitter_training_data.jsonl | Select-Object -Last 1

# 或访问统计接口
curl http://127.0.0.1:8881/stats
```

## ❓ 如果还是没有数据

1. **确认Ollama正在运行**
   ```bash
   curl http://localhost:11434/api/tags
   ```

2. **确认后端服务正在运行**
   ```bash
   curl http://127.0.0.1:8881/health
   ```

3. **测试后端功能**
   ```bash
   python test_save.py
   ```

4. **检查浏览器控制台** - 必须有日志输出，如果完全没有日志说明：
   - 扩展没有加载
   - 页面不匹配（不在 x.com 或 twitter.com）
   - content.js 有语法错误

5. **检查扩展权限** - 在 `chrome://extensions/` 确认扩展有：
   - ✅ 访问 x.com 的权限
   - ✅ 存储权限

## 📊 测试清单

- [ ] 修改了 manifest.json (8888 → 8881)
- [ ] 重新加载了 Chrome 扩展
- [ ] 清除了缓存
- [ ] 后端服务运行在 8881 端口
- [ ] Ollama 服务正常运行
- [ ] 访问 Twitter 并看到分析结果
- [ ] 控制台显示 "✅ 已保存至数据集"
- [ ] twitter_training_data.jsonl 文件存在且有内容
